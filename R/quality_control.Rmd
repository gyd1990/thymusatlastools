
---
title: "Cleaning the DGE Data"
author: "Eric Kernfeld"
date: "September 7, 2016"
output: html_document
---


###A QC tool

```{r}
#' Consistently label replicates
#'
#' @details We use the convention that the sample ID, which goes into the orig.ident variable,
#' looks like "e13_5_<irregular>". This helps form a consistent way of labeling replicates.
custom.make.unique = function(s, ...){
  label_dupes = function( s2, my_seq, seqgen = seq_along, sep = "_", do_singletons = F ) {
    if ( ( length(s2) == 1 ) && !do_singletons ) {
      s2
    }  else{
      paste(s2, seqgen(s2), sep = sep)
    }
  }
  f = function(x) label_dupes(x, ...)
  ave(as.character(s), s, FUN = f)
} 



#' Plot a dataset's tSNE embedding faceted by experimental metadata (default replicate and eday).
#'
#' @export
faceted_tsne = function( dge, results_path, ident.use = "orig.ident", eday.use = "eday", colour = "eday", 
                         width = 20, height = 12 ){
  plot_df = rbind( FetchData(dge, c( ident.use, eday.use, colour, "tSNE_1", "tSNE_2" ) ),
                   mutate( FetchData(dge, c( ident.use, eday.use, colour, "tSNE_1", "tSNE_2" ) ), 
                           orig.ident = "all", 
                           eday = "all") )
  p = ggplot(plot_df) + ggtitle("Cells stratified by replicate") + 
    facet_grid(as.formula(paste(ident.use, eday.use, sep="~"), )) + 
    geom_point(aes_string(x = "tSNE_1", y = "tSNE_2", colour = colour), size = 0.2) 
  fp = file.path(results_path, "tsne_replicates.pdf")
  cat( paste( "Saving faceted tSNE to", fp ) )
  ggsave( filename = fp, 
          plot = p, 
          width = width, height = height)
  return(p)
}
```

