
---
title: "Cleaning the DGE Data"
author: "Eric Kernfeld"
date: "September 7, 2016"
output: html_document
---


###A QC tool

```{r}
#' Consistently label replicates
#'
#' @details We use the convention that the sample ID, which goes into the orig.ident variable,
#' looks like "e13_5_<irregular>". This helps form a consistent way of labeling replicates.
custom.make.unique = function(s, ...){
  label_dupes = function( s2, my_seq, seqgen = seq_along, sep = "_", do_singletons = F ) {
    if ( ( length(s2) == 1 ) && !do_singletons ) {
      s2
    }  else{
      paste(s2, seqgen(s2), sep = sep)
    }
  }
  f = function(x) label_dupes(x, ...)
  ave(as.character(s), s, FUN = f)
} 


#' Plot a dataset's tSNE embedding, but faceted by replicate and embryonic day.
#'
#' @export
faceted_tsne = function( dge, results_path ){
  plot_df = rbind( FetchData(dge, c( "orig.ident", "eday", "tSNE_1", "tSNE_2" ) ),
                   mutate( FetchData(dge, c("orig.ident", "eday", "tSNE_1", "tSNE_2" ) ), 
                           orig.ident = "all", 
                           eday = "all") )
  old_levels = levels(plot_df$orig.ident)
  levels(plot_df$orig.ident) %<>% substring( 1, 3 ) %>% tolower %>% custom.make.unique( sep = ".5 rep ")
  write.table( cbind( old_levels, levels(plot_df$orig.ident) ) , quote = F, row.names = F )
  plot_df$rep = plot_df$orig.ident %>% substr( 11, 11 ) %>% as.character
  plot_df$rep [plot_df$rep ==""] = "1"
  p = ggplot(plot_df) + ggtitle("Cells stratified by replicate") + 
    facet_grid(rep~eday) + 
    geom_point(aes(x = tSNE_1, y = tSNE_2, colour = factor(eday)), size = 0.2) + 
    scale_color_manual(values = c(scales::hue_pal()(5), "gray"))
  fp = file.path(results_path, "tsne_replicates.pdf")
  cat( paste( "Saving faceted tSNE to", fp ) )
  ggsave( filename = fp, 
          plot = p, 
          width = 20, height = 12)
  return(p)
}
```

