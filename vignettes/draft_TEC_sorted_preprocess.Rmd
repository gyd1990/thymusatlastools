---
title: "Figure drafts for Jan 2017 submission"
author: "Eric Kernfeld"
date: "January 18, 2017"
output: html_document
---

####Data loading, preprocessing, and QC

```{r}
results_path = Sys.getenv( "FREEZR_DESTINATION" )

# # Retrieve sorted TECs
dge_sorted = inventory( tag = "ts_sorted" ) %>% readRDS

# # Remove parathyroid, plotting before&after on initial tSNE.
tsne_colored( dge_sorted, results_path = file.path( results_path, "pth" ), colour = "eday", cols.use = Thanksgiving_colors )
tsne_colored( dge_sorted, results_path = file.path( results_path, "pth" ), colour = "Pth"  )

atat( names(which.max(aggregate.nice(dge_sorted@data["Pth", ], dge_sorted@ident, mean)[, 1])) == "5" )
dge_sorted %<>% SubsetData( ident.use = dge_sorted@ident %>% unique %>% setdiff( "5" ) )

tsne_colored( dge_sorted, results_path = file.path( results_path, "no_pth" ), colour = "eday", cols.use = Thanksgiving_colors )
tsne_colored( dge_sorted, results_path = file.path( results_path, "no_pth" ), colour = "Pth" )

saveRDS( dge_sorted, file.path( results_path, "dge_sorted_clean.data") )

# # Retrieve clean overview TECs from 12/13 and study correlation with sorted counterparts
dge_overview = inventory( tag = "overview_clean_labeled" ) %>% readRDS
dge_overview %<>% SubsetData( ident.use = paste0( "TEC", 1:3 ) )
whole_tec_12 = dge_overview %>% SubsetData( subset.name = "eday", accept.high = 13, accept.low = 12 ) 
whole_tec_13 = dge_overview %>% SubsetData( subset.name = "eday", accept.high = 14, accept.low = 13 ) 
dge_sorted_12 =  dge_sorted %>% SubsetData( subset.name = "eday", accept.high = 13, accept.low = 12 ) 
dge_sorted_13 =  dge_sorted %>% SubsetData( subset.name = "eday", accept.high = 14, accept.low = 13 ) 

all_genes = union(dge_overview@data %>% rownames, dge_sorted@data %>% rownames )

# # Mean expression of each gene
whole_tec_12_expr  = whole_tec_12  %>% FetchDataZeroPad( all_genes ) %>% colMeans
whole_tec_13_expr  = whole_tec_13  %>% FetchDataZeroPad( all_genes ) %>% colMeans
dge_sorted_12_expr = dge_sorted_12 %>% FetchDataZeroPad( all_genes ) %>% colMeans
dge_sorted_13_expr = dge_sorted_13 %>% FetchDataZeroPad( all_genes ) %>% colMeans

# # Proportion expressing each gene
whole_tec_12_prop  = whole_tec_12  %>% FetchDataZeroPad( all_genes ) %>% apply( 2, prop_nz )
whole_tec_13_prop  = whole_tec_13  %>% FetchDataZeroPad( all_genes ) %>% apply( 2, prop_nz )
dge_sorted_12_prop = dge_sorted_12 %>% FetchDataZeroPad( all_genes ) %>% apply( 2, prop_nz )
dge_sorted_13_prop = dge_sorted_13 %>% FetchDataZeroPad( all_genes ) %>% apply( 2, prop_nz )

ols = function(...) outlier_labeled_scatterplot( prop_label = 0.005, ...)
{
  pdf( file.path( results_path, "sorted_whole_corr.pdf" ) )
  ols( data.frame(        whole_tec_12_expr, dge_sorted_12_expr, gene = all_genes ), 
       main = paste0("Day 12 total expression, r = ",
                     cor( whole_tec_12_expr, dge_sorted_12_expr ) %>% round( 2 ) ) )
  
  ols( data.frame(        whole_tec_12_prop, dge_sorted_12_prop, gene = all_genes ), 
       main = paste0("Day 12 proportion expressing, r = ", 
                     cor( whole_tec_12_prop, dge_sorted_12_prop ) %>% round( 2 ) ) )
  
  ols( data.frame(        whole_tec_13_expr, dge_sorted_13_expr, gene = all_genes ), 
       main = paste0("Day 13 total expression, r = ", 
                     cor( whole_tec_13_expr, dge_sorted_13_expr ) %>% round( 2 ) ) )

  ols( data.frame(         whole_tec_13_prop, dge_sorted_13_prop, gene = all_genes ),
        main = paste0("Day 13 proportion expressing, r = ", 
                     cor( whole_tec_13_prop, dge_sorted_13_prop ) %>% round( 2 ) ) )
  dev.off()
}

ols = function(...) outlier_labeled_scatterplot( prop_label = 0, ...)
{
  pdf( file.path( results_path, "sorted_whole_corr_no_label.pdf" ) )
  ols( data.frame(        whole_tec_12_expr, dge_sorted_12_expr, gene = all_genes ), 
       main = paste0("Day 12 total expression, r = ",
                     cor( whole_tec_12_expr, dge_sorted_12_expr ) %>% round( 2 ) ) )
  
  ols( data.frame(        whole_tec_12_prop, dge_sorted_12_prop, gene = all_genes ), 
       main = paste0("Day 12 proportion expressing, r = ", 
                     cor( whole_tec_12_prop, dge_sorted_12_prop ) %>% round( 2 ) ) )
  
  ols( data.frame(        whole_tec_13_expr, dge_sorted_13_expr, gene = all_genes ), 
       main = paste0("Day 13 total expression, r = ", 
                     cor( whole_tec_13_expr, dge_sorted_13_expr ) %>% round( 2 ) ) )

  ols( data.frame(         whole_tec_13_prop, dge_sorted_13_prop, gene = all_genes ),
        main = paste0("Day 13 proportion expressing, r = ", 
                     cor( whole_tec_13_prop, dge_sorted_13_prop ) %>% round( 2 ) ) )
  dev.off()
}

# # Clean up namespace and free some memory
# rm(dge_overview); gc()
# rm( whole_tec_12     , whole_tec_13     , dge_sorted_12     , dge_sorted_13      ); gc()
# rm( whole_tec_12_expr, whole_tec_13_expr, dge_sorted_12_expr, dge_sorted_13_expr ); gc()
# rm( whole_tec_12_prop, whole_tec_13_prop, dge_sorted_12_prop, dge_sorted_13_prop ); gc()
```