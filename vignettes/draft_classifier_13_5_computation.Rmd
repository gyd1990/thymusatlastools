---
title: "Figure drafts for Jan 2017 submission"
author: "Eric Kernfeld"
date: "January 18, 2017"
output: html_document
---

```{r}
results_path = Sys.getenv( "FREEZR_DESTINATION" )

# # Retrieve overview data
path_to_labeled_Seurat_obj = inventory( tag = "overview_clean_labeled" )

dge = readRDS( path_to_labeled_Seurat_obj )
dge13 = SubsetData( dge, cells.use = rownames( subset( FetchData( dge, "eday" ), eday==13.5 ) ) )
table( dge13@ident ) # there's 2 small categories to remove
dge13 %<>% SubsetData( ident.use = setdiff(levels(dge13@ident), c("PTH", "BLD4")) ) 
table( dge13@ident ) 
rm( dge ); gc()

# # Get data with outlying cluster and explore it
dge13_pth = "whole_e13_5_pth" %>% get_sample_groups %>% down_idx %>% 
  load_thymus_profiling_data %>% dge_merge_list %>% seuratify_thy_data( results_path )

all_params = expand.grid( cc_method = c( "average" ),
                          excess_var_cutoff = c( 0.8 ),
                          log_expr_cutoff = c( 0.10 ), 
                          num_genes_to_select = NA, 
                          prop_genes_to_select = NA, 
                          var_gene_method = "seurat",
                          num_pc = c( 25 ), 
                          clust_method = "SNN",
                          clust_granularities_as_string = "0.5",
                          plot_all_var_genes = F,
                          stringsAsFactors = F )
dge13_pth = explore_embeddings( dge13_pth, results_path = file.path( results_path, "initial" ), 
                                test_mode = F, all_params)

# # Run classifier with reject option
dge13_pth = knn_classifier( dge_train = dge13, dge_test = dge13_pth, 
                            vars.all = NULL, my_transform = "PCA_20", 
                            k = 25, reject_prop = 0.01 )

# # Remove doublets from new data and redo tSNE
dge13_pth = DBClustDimension( dge13_pth, G.use = 1.5 )
tsne_colored( dge13_pth,             results_path, "ident", fig_name =       "DBclust.ident" )
dge13_pth_no_doublets = SubsetData( dge13_pth, ident.use = setdiff(unique(dge13_pth@ident), c(1, 12)) )
tsne_colored( dge13_pth_no_doublets, results_path, "ident", fig_name = "nodub_DBclust.ident" )
cat("Out of ", ncol( dge13_pth@data ), " cells, \n")
cat("there were ", ncol( dge13_pth@data ) - ncol( dge13_pth_no_doublets@data ), " putative doublets removed.\n")
all_params = expand.grid( cc_method = c( "average" ),
                          excess_var_cutoff = c( 0.8 ),
                          log_expr_cutoff = c( 0.10 ), 
                          num_genes_to_select = NA, 
                          prop_genes_to_select = NA, 
                          var_gene_method = "seurat",
                          num_pc = c( 25 ), 
                          clust_method = "SNN",
                          clust_granularities_as_string = "0.5",
                          plot_all_var_genes = F,
                          stringsAsFactors = F )
dge13_pth_no_doublets %<>% explore_embeddings( results_path = file.path( results_path, "nodub" ),
                                               test_mode = F, all_params)



```


