---
title: "Figure drafts for Jan 2017 submission"
author: "Eric Kernfeld"
date: "January 18, 2017"
output: html_document
---

```{r}
library(enrichR)
library(gridExtra)
library(grid)
results_path = Sys.getenv( "FREEZR_DESTINATION" )

# # Retrieve test and training data
pth_table_path = inventory( tag = "classifier_experiment_pth_markers" ) 
pth_table = read.table( pth_table_path, stringsAsFactors = F )
pth_genes = subset( pth_table, avg_diff > 1.5 ) %>% get(pos = ., "gene")

desired_db = c( "GO_Biological_Process_2015", "GO_Molecular_Function_2015", 
                "MGI_Mammalian_Phenotype_Level_3",  "MGI_Mammalian_Phenotype_Level_4", "Human_Phenotype_Ontology" )
desired_db = gsub( x = desired_db, pattern = " ", replacement = "_" )

# # Get annotations and save to 10 for each DB
output_table = enrichR::enrichGeneList( gene.list = pth_genes, databases = desired_db ) 
output_table %<>% group_by( database ) %>% top_n( wt = -pval, n = 10) 
write.table( x = output_table, file = file.path( results_path, paste0("annot_classifier_reject_raw.txt" ) ),
             sep = "\t", quote = F, row.names = T, col.names = T )
output_table %<>% top_n( wt = -pval, n = 5) 

output_table$pval = NULL
output_table %<>% mutate( log10_qval = round( log10( qval ), 1 ) )
output_table$qval = NULL
output_table = output_table[c(1,2,4,3)]
output_table$genes  = NULL 

# # Set up color palette and print to file
n_colors = length(unique(output_table$database)); 
color_idx = output_table$database %>% factor(levels = desired_db, ordered = T) %>% as.integer
my_cols = scales::hue_pal()(n_colors)[ color_idx ]
theme_col_by_db = ttheme_minimal( core=list( bg_params = list( fill = my_cols ) ) )
ggsave( tableGrob( d = output_table, theme = theme_col_by_db ), 
        file = file.path( results_path, paste0("annot_classifier_reject.pdf")  ), 
        width = 15, height = 10 )
```

