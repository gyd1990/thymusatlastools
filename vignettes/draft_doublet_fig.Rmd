---
title: "Figure drafts for Jan 2017 submission"
author: "Eric Kernfeld"
date: "January 18, 2017"
output: html_document
---

```{r}
results_path = Sys.getenv("FREEZR_DESTINATION")

# # Retrieve Seurat obj and label clusters

path_to_Seurat_obj = freezr::inventory( tag = "overview_explore" )
dge = readRDS( path_to_Seurat_obj )

dge = Seurat::DBClustDimension( dge, G.use = 1.1 )
centers = aggregate.nice( FetchData(dge, c("tSNE_1", "tSNE_2")), by=FetchData(dge, "ident"), mean ) %>% as.data.frame
centers$cluster = as.character( 1:nrow(centers) )
p = custom_feature_plot( dge, colour = "ident", cols.use = c("grey",  scales::hue_pal()( 27 ) ) )
# p = p + geom_text( data = centers, aes_string(x = "tSNE_1", y = "tSNE_2", label = "cluster", size = 8 ) )
ggsave(file.path(results_path, "clusters_before_naming.pdf"), p, height = 7, width = 8)

dge = Seurat::SetIdent( dge, ident.use = as.character( dge@data.info$DBclust.ident ) )
old_ident_size_ordered =  sort( table(dge@ident), decreasing = T) 
new_ident = rep("BLD", length(unique(dge@ident)))
new_ident[1] = "UNK"
new_ident[c(2, 9, 19, 18, 16, 7, 14, 25)] = "TEC"
new_ident[c(5, 21)] = "MES"
new_ident[c(6, 7)] = "DUB_mes_tec"
new_ident[9] = "PTH"
new_ident[11] = "END"
new_ident[14] = "DUB_bld_tec"
for( i in 1:length( unique( dge@ident ) ) ){
  dge = Seurat::RenameIdent( dge, i, new_ident[i] )
}
# custom_feature_plot( dge, "ident" )

cell_types_ordered = c( "BLD", "END", "MES", "PTH", "TEC", 
                        "DUB_mes_tec", "DUB_bld_mes", "DUB_bld_tec", "DUB_all", "UNK" )

dge@ident = factor( dge@ident, levels = cell_types_ordered )
# custom_feature_plot( dge, "ident" )

# Save labeled DGE and featureplot with all cells
saveRDS( dge, file.path( results_path, "dge_labeled.data" ) )
my_cols = c(  "firebrick", "pink", "yellow2","black","steelblue4",
              "green", "purple", "gray" )
p_feat = custom_feature_plot( dge, "ident", cols.use = my_cols ) + ggtitle("Main cell types")
ggsave( filename = file.path( results_path, "overview_all_cells_no_leg.pdf"),
        plot = p_feat + theme(legend.position = "none"),
        height = 7, width = 8 )
ggsave( filename = file.path( results_path, "overview_all_cells.pdf"),
        plot = p_feat,
        height = 7, width = 8 )
write.table( table(dge@ident), file.path( results_path, "cluster_sizes.txt" ), quote = F, sep = "\t" )

# # Print feature plots and heatmap for cell type and known markers
genes_in_order = c( "Ptprc",  "Plac8",
                    "Esam", "Egfl7", "Emcn",
                    "Pdgfra", "Col3a1", 
                    "Pth",    "Chga", "Epcam", "Prss16", "Psmb11")
p_heat = make_heatmap_for_table( dge = dge, 
                                 ident.use = "ident",
                                 genes_in_order = genes_in_order,
                                 desired_cluster_order = cell_types_ordered,
                                 normalize = "row")
p_heat = p_heat + ggtitle("Known cluster markers") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_heat
ggsave( filename = file.path( results_path, "doublet_heatmap.pdf"),
        plot = p_heat,
        width = 6, height = 6)
save_feature_plots( dge, results_path, 
                    gene_list = c( "ident", genes_in_order ), 
                    gene_list_name = "genes_in_order" )


ct_rep_raw_data = Seurat::FetchData(dge, c("ident", "orig.ident" ) )   
dub_types  = c( "DUB_bld_mes", "DUB_mes_tec", "DUB_bld_tec" )
dubs_not_found = setdiff( dub_types, levels( ct_rep_raw_data$ident ) )
levels(ct_rep_raw_data$ident) = c( levels(ct_rep_raw_data$ident), dubs_not_found )
ct_by_rep = table( ct_rep_raw_data )
main_types = c( "MES", "BLD", "TEC", "PTH", "END" )
big_types  = c( "MES", "BLD", "TEC" )
exp_obs_all = array(NA, dim = c(5, 2, 1 + length(colnames(ct_by_rep))))
dimnames(exp_obs_all)[[3]] = c( colnames( ct_by_rep ) , "rep_average" )
for( rep in colnames( ct_by_rep ) ){
  x = expected_doublet_counts( ct_by_rep[main_types, rep], rate = 0.03 )
  x_obs = x[c("BLD_MES",  "MES_TEC", "BLD_TEC")]
  x_same =      sum( x[c( "MES_MES", "BLD_BLD", "TEC_TEC", "END_END", "PTH_PTH"                       ) ] )
  x_rest_diff = sum( x[c( "MES_PTH", "BLD_PTH", "PTH_TEC", "END_MES", "BLD_END", "END_TEC", "END_PTH" ) ] ) 
  x = c( x_obs, REST_DIFF = x_rest_diff, UNK = NA ) 
  exp_obs_all[, , rep] = as.matrix( data.frame( expected = x, 
                                                observed = c( ct_by_rep[dub_types, rep], NA,
                                                              ct_by_rep["UNK", rep]) ) )
  rownames(exp_obs_all) = names(x)
  colnames(exp_obs_all) =  c("expected", "observed")
} 
exp_obs_all[, , "rep_average"] = apply( exp_obs_all[, , -dim(exp_obs_all)[3]], c(1, 2), mean)
exp_obs_all_long = melt( exp_obs_all )
colnames( exp_obs_all_long ) = c("cell_types", "obs_vs_exp", "rep", "count")
exp_obs_all_long$cell_types = factor(exp_obs_all_long$cell_types %>% as.character,
                                     levels = names(x) )
write.table( exp_obs_all_long, file = file.path( results_path, "doublet_counts.txt" ), 
             sep = "\t", quote = F, row.names = F, col.names = T ) 
p_ndub = ggplot(exp_obs_all_long) + ggtitle("Expected and observed doublet counts") + 
  geom_tile(aes(obs_vs_exp, cell_types, fill = count)) + 
  geom_text(aes(obs_vs_exp, cell_types, label = round(count, 1)), colour = "white") + 
  facet_wrap(~rep) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_ndub
ggsave( filename = file.path( results_path, "doublet_counts.pdf" ),
        plot = p_ndub, 
        width = 12, height = 12)


```

