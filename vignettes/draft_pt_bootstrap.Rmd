---
title: "Figure drafts for Jan 2017 submission"
author: "Eric Kernfeld"
date: "January 18, 2017"
output: html_document
---

```{r}
results_path = Sys.getenv( "FREEZR_DESTINATION" )

dge = inventory( tag = "monocle_sorted" ) %>% readRDS

do_one = function( i ){
  cells.use = sample( dge@cell.names, size = round( 0.75 * length( dge@cell.names ) ) )
  mobj = call_monocle_on_seurat( dge = Seurat::SubsetData( object = dge, cells.use = cells.use ), 
                                 results_path, 
                                 monocle_params = list( reset_var_genes       = T, 
                                                        log_scale_expr_thresh = 0.1,
                                                        excess_disp           = 1,
                                                        num_mature_types      = NULL,
                                                        reduction_method      = "DDRTree"  ) )
  monocle_important_stuff = data.frame( barcode = sampleNames( mobj ),
                                        eday = phenoData( mobj )[["eday"]],
                                        pseudotime = phenoData( mobj )[["Pseudotime"]],
                                        monocle_state = phenoData( mobj )[["State"]],
                                        branch_viz_1 = mobj@reducedDimS[1, ],
                                        branch_viz_2 = mobj@reducedDimS[2, ] ) 
  write.table( monocle_important_stuff,
               file.path( results_path, paste0( "monocle_results_", i, ".data" ) ),
               sep = "\t", col.names = T, row.names = F, quote = F )
}

# # Do bootstrapping
num_bootstrap_samples = 200
for(i in 1:num_bootstrap_samples){
  if( i %% 20 == 0 ) {
    cat( " ", i, " ")
  } else {
    cat(".")
  }
  success = F
  while( !success ){
    success = tryCatch( {  do_one( i ); this_gets_returned = T }, 
                        error = function( e ){ return( F ) } ) 
  }
}


```
