---
title: "Figure drafts for Jan 2017 submission"
author: "Eric Kernfeld"
date: "January 18, 2017"
output: html_document
---

```{r}
results_path = Sys.getenv( "FREEZR_DESTINATION" )

# # Retrieve Monocle output and simple branch labels
dge_branch = inventory( tag = "monocle_sorted" ) %>% readRDS
simple_branch = freezr::inventory( tag = "bootstrap_results_assembled" ) %>% 
  dirname %>%
  file.path( "full_run.txt" ) %>% 
  read.table(header = T, stringsAsFactors = F) 
rownames( simple_branch )  = simple_branch$barcode
simple_branch %<>% subset(select = "simple_branch") 
dge_branch %<>% AddMetaData( simple_branch )
dge_branch = SetIdent( dge_branch, ident.use = simple_branch[["simple_branch"]] )

# # Duplicate progenitors and branchpoint cells, flipping mTEC PT axis backwards
dge_prog_ctec = SubsetData(dge_branch, ident.use = setdiff(unique(dge_branch@ident), "mTEC"))
dge_prog_mtec = SubsetData(dge_branch, ident.use = setdiff(unique(dge_branch@ident), "cTEC"))
dge_prog_mtec_raw = deseuratify_raw_data(dge_prog_mtec); colnames( dge_prog_mtec_raw ) %<>% paste0("_mTEC")
dge_prog_ctec_raw = deseuratify_raw_data(dge_prog_ctec); colnames( dge_prog_ctec_raw ) %<>% paste0("_cTEC")
meta_mTEC = dge_prog_mtec@data.info; rownames( meta_mTEC ) %<>% paste0("_mTEC")
meta_cTEC = dge_prog_ctec@data.info; rownames( meta_cTEC ) %<>% paste0("_cTEC")
meta_mTEC$pseudotime = -meta_mTEC$pseudotime
dge_branch_dup_raw = dge_merge_list( list( mtec = dge_prog_mtec_raw, 
                                           ctec = dge_prog_ctec_raw ) )
rm(dge_prog_mtec, dge_prog_ctec)
rm(dge_prog_mtec_raw, dge_prog_ctec_raw)
dge_branch_dup = seuratify_thy_data( dge_branch_dup_raw, results_path, 
                                     test_mode = F, do.plot = F,
                                     min.cells = 0, min.genes = 0 )
rm(dge_branch_dup_raw)
dge_branch_dup = AddMetaData( dge_branch_dup, rbind( meta_mTEC, meta_cTEC ))
pt_dep_list = smooth_and_cluster_genes ( dge = dge_branch_dup, 
                                         results_path, 
                                         num_periods_initial_screen = 30 )
branching_heatmap = heatmap_gene_clusters( dge = dge_branch_dup,
                                           results_path, 
                                           cluster_mod = pt_dep_list$cluster_mod, 
                                           smoothers = pt_dep_list$smoothers, 
                                           genes_to_label = read.table( file.path( PATH_TO_TABLES, 
                                                                                   "genes_to_display_Figure6d.txt" ) )[[1]] )
                                           
for( my_cluster in 1:max(pt_dep_list$gene_stats$cluster) ){
  geneset = pt_dep_list$gene_stats %>% subset( cluster==my_cluster ) %>% get(x = "gene", pos = .) %>% as.character
  do_enrichr( results_path = file.path( results_path, "annot" ), 
              geneset,
              geneset_name = paste0( "cluster_", my_cluster ),
              N_ANNOT_PER_DB = 5 )
}

```
